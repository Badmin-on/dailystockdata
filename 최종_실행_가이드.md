# 🎯 최종 실행 가이드

## ✅ 현재 상태

- **1단계 완료:** 데이터 정규화 성공 (÷ 100,000,000)
- **2단계 필요:** View 생성 및 갱신

---

## 🚀 지금 실행할 스크립트

### 파일: `scripts/create-or-refresh-views.sql`

이 스크립트는:
- ✅ 기존 View 자동 삭제
- ✅ 새로운 View 생성
- ✅ 정규화된 데이터로 계산
- ✅ 자동 검증 및 샘플 표시

---

## 📝 실행 방법

### Supabase SQL Editor에서:

1. **새 쿼리 창 열기** (기존 내용 모두 삭제)

2. **스크립트 복사**
   ```
   파일 위치: /home/user/webapp/scripts/create-or-refresh-views.sql
   ```

3. **붙여넣기 후 "Run" 클릭**

4. **결과 확인** (여러 Result 탭이 나타남)

---

## 📊 예상 결과

### Result 1: View 생성 확인
```
status: ✅ mv_consensus_changes created!
total_records: 844
```

### Result 2: 샘플 데이터 (상위 10개 기업)
```
name        | code   | revenue_growth_1month | op_profit_growth_1month | consensus_score
현대차      | 005380 | 2.5                  | 3.2                     | 80
삼성전자    | 005930 | 1.8                  | 2.1                     | 80
LG화학      | 051910 | 5.8                  | 6.2                     | 100
```

**✅ 중요:** 
- 증감률이 **-100% 또는 +100%가 아님**
- 점수가 **다양하게 분포됨 (0, 20, 40, 60, 80, 100)**

### Result 3: 점수 분포
```
score_range    | count
NULL           | 150
0 points       | 85
1-29 points    | 0
30-59 points   | 0
60-79 points   | 0
100 points     | 609
```

**예상:**
- NULL: 데이터 부족한 기업
- 0~100: 다양한 점수 분포

---

## ✅ 성공 확인 방법

### 1. SQL 결과 확인
- ✅ "mv_consensus_changes created" 메시지 확인
- ✅ "mv_stock_analysis created" 메시지 확인
- ✅ 샘플 데이터에서 현실적인 증감률 확인 (-10% ~ +20%)

### 2. 웹 페이지 테스트

로컬 서버 실행:
```bash
cd /home/user/webapp
npm run dev
```

브라우저에서 접속:
```
http://localhost:3000/investment-finder
```

확인 사항:
- ✅ 기업 목록이 표시되는가?
- ✅ 점수가 다양한가? (0~100)
- ✅ 증감률이 현실적인가?
- ✅ 필터가 작동하는가?

---

## 🔍 문제 해결

### 에러 1: "permission denied"
```sql
-- Service Role Key가 설정되어 있는지 확인
SELECT current_user;
```

### 에러 2: "table does not exist"
```sql
-- 테이블 확인
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;
```

필요한 테이블:
- `companies`
- `financial_data`
- `daily_stock_prices`

---

## 🎯 다음 단계

### View 생성 성공 후:

1. **투자기회 발견 페이지 테스트**
   - 점수 분포 확인
   - 필터 동작 확인
   - 상세 정보 확인

2. **실제 투자 기회 탐색**
   - 컨센서스 개선 기업 찾기
   - 주가 저평가 기업 찾기
   - 조합 조건으로 필터링

3. **정기 데이터 업데이트**
   - Vercel Cron으로 자동화
   - 매일 최신 데이터 수집
   - View 자동 갱신

---

## 📁 스크립트 파일 요약

| 순서 | 파일 | 상태 | 용도 |
|------|------|------|------|
| 1 | `fix-data-scale-simple.sql` | ✅ 완료 | 데이터 정규화 |
| 2 | `create-or-refresh-views.sql` | ⏳ 실행 대기 | View 생성/갱신 |
| 3 | `최종_실행_가이드.md` | 📖 현재 | 이 가이드 |

---

## ⚡ 빠른 시작

**지금 바로:**
1. Supabase SQL Editor 열기
2. `create-or-refresh-views.sql` 복사
3. 실행 (Run)
4. 결과 확인

**소요 시간:** 2-3분

---

## 🎉 최종 목표

**Before (현재):**
```
❌ 모든 기업 100점
❌ 증감률 -100% 또는 +100%만
❌ 투자 기회 찾기 불가능
```

**After (실행 후):**
```
✅ 점수 다양 (0~100 분포)
✅ 증감률 현실적 (-10% ~ +20%)
✅ 투자 기회 명확히 식별 가능
```

---

**현재 단계:** 🟢 View 생성 대기 중  
**다음 액션:** `create-or-refresh-views.sql` 실행  
**예상 결과:** 완전 정상 작동! 🚀

화이팅입니다! 이번이 마지막 단계예요! 🎊
