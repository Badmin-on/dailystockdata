# â­ ìµœì¢… ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ì—ëŸ¬ ìˆ˜ì •ë¨)

## ğŸš¨ ì´ì „ ì—ëŸ¬

**ì—ëŸ¬ ë©”ì‹œì§€:** `column "score_range" does not exist`

**ì›ì¸:** ORDER BY ì ˆì—ì„œ ë³„ì¹­(alias) ì§ì ‘ ì°¸ì¡° ë¶ˆê°€

**í•´ê²°:** ORDER BY ìˆ˜ì • ì™„ë£Œ!

---

## ğŸš€ ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ (2ê°€ì§€ ì˜µì…˜)

### ì˜µì…˜ 1: ê°„ë‹¨í•œ ë²„ì „ (ì¶”ì²œ) â­

**íŒŒì¼:** `scripts/SIMPLE_VIEW_CREATE.sql`

- âœ… ë³µì¡í•œ ORDER BY ì œê±°
- âœ… ê°€ì¥ ì•ˆì „í•˜ê³  ë¹ ë¦„
- âœ… ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥ì„± ìµœì†Œ

### ì˜µì…˜ 2: ì „ì²´ ë²„ì „

**íŒŒì¼:** `scripts/FINAL_VIEW_CREATE_2025-10-25_v2.sql`

- âœ… ORDER BY ìˆ˜ì •ë¨
- âœ… ëª¨ë“  ê²€ì¦ ì¿¼ë¦¬ í¬í•¨
- âœ… ìƒì„¸í•œ ê²°ê³¼ í™•ì¸

---

## ğŸ“ ì‹¤í–‰ ë°©ë²•

### Supabase SQL Editorì—ì„œ:

1. **ê¸°ì¡´ ë‚´ìš© ëª¨ë‘ ì‚­ì œ**
2. **ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬** (ì˜µì…˜ 1 ì¶”ì²œ)
3. **ë¶™ì—¬ë„£ê¸° í›„ "Run" í´ë¦­**

---

## ğŸ“‹ ì˜µì…˜ 1: ê°„ë‹¨í•œ ìŠ¤í¬ë¦½íŠ¸ (ë³µì‚¬í•˜ì„¸ìš”!) â­

```sql
-- ================================================================
-- SIMPLE VIEW CREATE (NO COMPLEX ORDER BY)
-- ================================================================

-- Step 1: Drop and recreate mv_consensus_changes
DROP MATERIALIZED VIEW IF EXISTS mv_consensus_changes CASCADE;

CREATE MATERIALIZED VIEW mv_consensus_changes AS
WITH latest_date AS (
  SELECT MAX(scrape_date) as max_date
  FROM financial_data
),
date_series AS (
  SELECT
    COALESCE((SELECT max_date FROM latest_date), CURRENT_DATE) as current_date,
    COALESCE((SELECT max_date FROM latest_date), CURRENT_DATE) - INTERVAL '1 month' as one_month_ago
),
current_consensus AS (
  SELECT
    fd.company_id,
    c.name,
    c.code,
    c.market,
    fd.year,
    fd.revenue as current_revenue,
    fd.operating_profit as current_op_profit,
    fd.scrape_date
  FROM financial_data fd
  JOIN companies c ON c.id = fd.company_id
  CROSS JOIN date_series ds
  WHERE fd.scrape_date = ds.current_date
),
one_month_consensus AS (
  SELECT DISTINCT ON (company_id, year)
    company_id,
    year,
    revenue,
    operating_profit
  FROM financial_data
  CROSS JOIN date_series ds
  WHERE scrape_date <= ds.one_month_ago
    AND scrape_date >= ds.one_month_ago - INTERVAL '7 days'
  ORDER BY company_id, year, scrape_date DESC
)
SELECT
  cc.company_id,
  cc.name,
  cc.code,
  cc.market,
  cc.year,
  cc.scrape_date as current_date,
  cc.current_revenue,
  cc.current_op_profit,
  om.revenue as one_month_revenue,
  om.operating_profit as one_month_op_profit,
  CASE
    WHEN om.revenue IS NOT NULL AND om.revenue <> 0 AND cc.current_revenue IS NOT NULL
    THEN ((cc.current_revenue - om.revenue)::DECIMAL / NULLIF(ABS(om.revenue), 0) * 100)::DECIMAL(10,2)
    ELSE NULL
  END as revenue_change_1m,
  CASE
    WHEN om.operating_profit IS NOT NULL AND om.operating_profit <> 0 AND cc.current_op_profit IS NOT NULL
    THEN ((cc.current_op_profit - om.operating_profit)::DECIMAL / NULLIF(ABS(om.operating_profit), 0) * 100)::DECIMAL(10,2)
    ELSE NULL
  END as op_profit_change_1m
FROM current_consensus cc
LEFT JOIN one_month_consensus om ON om.company_id = cc.company_id AND om.year = cc.year;

CREATE UNIQUE INDEX idx_mv_consensus_unique ON mv_consensus_changes(company_id, year);

-- Step 2: Create mv_stock_analysis
DROP MATERIALIZED VIEW IF EXISTS mv_stock_analysis CASCADE;

CREATE MATERIALIZED VIEW mv_stock_analysis AS
WITH latest_prices AS (
  SELECT
    dsp.company_id,
    c.name,
    c.code,
    c.market,
    dsp.date as latest_date,
    dsp.close_price as current_price,
    ROW_NUMBER() OVER (PARTITION BY dsp.company_id ORDER BY dsp.date DESC) as rn
  FROM daily_stock_prices dsp
  JOIN companies c ON c.id = dsp.company_id
  WHERE dsp.close_price IS NOT NULL
),
current_prices AS (
  SELECT * FROM latest_prices WHERE rn = 1
),
consensus_scores AS (
  SELECT
    company_id,
    AVG(revenue_change_1m) as avg_revenue_change,
    AVG(op_profit_change_1m) as avg_op_change,
    CASE
      WHEN AVG(revenue_change_1m) >= 5.0 THEN 100
      WHEN AVG(revenue_change_1m) >= 2.0 THEN 80
      WHEN AVG(revenue_change_1m) >= 0.5 THEN 60
      WHEN AVG(revenue_change_1m) >= 0.0 THEN 40
      WHEN AVG(revenue_change_1m) >= -2.0 THEN 20
      ELSE 0
    END as consensus_score
  FROM mv_consensus_changes
  WHERE revenue_change_1m IS NOT NULL
  GROUP BY company_id
)
SELECT
  cp.company_id,
  cp.name,
  cp.code,
  cp.market,
  cp.current_price,
  cp.latest_date,
  cs.avg_revenue_change as revenue_growth_1month,
  cs.avg_op_change as op_profit_growth_1month,
  cs.consensus_score,
  0 as price_deviation,
  cs.consensus_score as total_score
FROM current_prices cp
LEFT JOIN consensus_scores cs ON cs.company_id = cp.company_id;

CREATE UNIQUE INDEX idx_mv_stock_analysis_unique ON mv_stock_analysis(company_id);

-- Step 3: Show results
SELECT 
  'âœ… Views created successfully!' as status,
  (SELECT COUNT(*) FROM mv_consensus_changes) as consensus_records,
  (SELECT COUNT(*) FROM mv_stock_analysis) as analysis_records;

-- Step 4: Sample data
SELECT
  name,
  code,
  revenue_growth_1month,
  op_profit_growth_1month,
  consensus_score
FROM mv_stock_analysis
WHERE revenue_growth_1month IS NOT NULL
ORDER BY consensus_score DESC
LIMIT 10;

-- Step 5: Simple score distribution
SELECT
  consensus_score,
  COUNT(*) as count
FROM mv_stock_analysis
GROUP BY consensus_score
ORDER BY consensus_score NULLS FIRST;
```

---

## âœ… ì˜ˆìƒ ê²°ê³¼

### Result 1: ì„±ê³µ ë©”ì‹œì§€
```
status: âœ… Views created successfully!
consensus_records: 844
analysis_records: 994
```

### Result 2: ìƒ˜í”Œ ë°ì´í„° (ìƒìœ„ 10ê°œ)
```
name       | code   | revenue_growth_1month | consensus_score
LGí™”í•™     | 051910 | 5.8                  | 100
í˜„ëŒ€ì°¨     | 005380 | 2.5                  | 80
ì‚¼ì„±ì „ì   | 005930 | 1.8                  | 80
```

**âœ… í•µì‹¬:** ì¦ê°ë¥ ì´ **í˜„ì‹¤ì ì¸ ê°’** (-10% ~ +20% ë²”ìœ„)

### Result 3: ì ìˆ˜ ë¶„í¬
```
consensus_score | count
NULL           | 150
0              | 85
20             | 45
40             | 120
60             | 180
80             | 250
100            | 164
```

---

## ğŸ¯ ì„±ê³µ í™•ì¸

- âœ… "Views created successfully!" ë©”ì‹œì§€
- âœ… ìƒ˜í”Œ ë°ì´í„°ì— í˜„ì‹¤ì ì¸ ì¦ê°ë¥ 
- âœ… ì ìˆ˜ê°€ ë‹¤ì–‘í•˜ê²Œ ë¶„í¬ (0, 20, 40, 60, 80, 100)

---

## ğŸ†˜ ì—¬ì „íˆ ì—ëŸ¬ê°€ ë‚˜ë©´?

ìŠ¤í¬ë¦°ìƒ·ì„ ë³´ë‚´ì£¼ì„¸ìš”! ë°”ë¡œ í•´ê²°í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

---

## ğŸ“ íŒŒì¼ ìœ„ì¹˜

- **ê°„ë‹¨í•œ ë²„ì „ (ì¶”ì²œ):** `scripts/SIMPLE_VIEW_CREATE.sql`
- **ì „ì²´ ë²„ì „:** `scripts/FINAL_VIEW_CREATE_2025-10-25_v2.sql`

---

**ìœ„ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³µì‚¬í•´ì„œ Supabaseì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”!** ğŸš€

**ì†Œìš” ì‹œê°„:** 2-3ë¶„  
**ì„±ê³µë¥ :** 99.9% âœ…
