# 📅 매일 자동 데이터 수집 설정 가이드

## 🎯 목표

**매일 자동으로:**
1. 📊 **재무 데이터 수집** - 1,000개 기업의 컨센서스 정보
2. 💰 **주가 데이터 수집** - 평일 종가 데이터
3. 📈 **변화 추적** - 과거 데이터와 비교하여 증감률 계산
4. 🎯 **투자 기회 발견** - 조건에 맞는 기업 자동 선별

---

## ✅ 이미 설정된 것들

### 1. Cron Job 스케줄 (`vercel.json`)

```json
{
  "crons": [
    {
      "path": "/api/collect-data",
      "schedule": "0 14 * * *",
      "comment": "매일 23:00 KST - 재무 데이터 수집"
    },
    {
      "path": "/api/collect-daily-prices",
      "schedule": "0 11 * * 1-5",
      "comment": "평일 20:00 KST - 주가 데이터 수집"
    }
  ]
}
```

**실행 시간:**
- **재무 데이터:** 매일 23:00 (한국 시간)
- **주가 데이터:** 평일 20:00 (한국 시간, 장 마감 후)

### 2. 데이터 수집 API

**재무 데이터:**
- 파일: `/app/api/collect-data/route.ts`
- 수집 내용: FnGuide 컨센서스 (매출, 영업이익)
- 대상: KOSPI 500 + KOSDAQ 500 = 1,000개 기업

**주가 데이터:**
- 파일: `/app/api/collect-daily-prices/route.ts`
- 수집 내용: 네이버 증권 최신 종가
- 대상: DB에 등록된 모든 기업

### 3. 환경 변수

```env
NEXT_PUBLIC_SUPABASE_URL=https://gakqqmhubnbswqmnpprv.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_KEY=eyJ...
CRON_SECRET=a8f4c2d1b9e7f6a3c5d8e2b4f7a9c1d3e5f8a2b6c9d4e7f1a3b8c5d9e2f6a4b7
```

---

## 🚀 Vercel에서 Cron 활성화하기

### 1단계: Vercel 프로젝트 설정

1. **Vercel Dashboard 접속**
   - https://vercel.com/dashboard

2. **프로젝트 선택**
   - `dailystockdata` 클릭

3. **Settings → Cron Jobs**

4. **확인 사항:**
   - ✅ 2개의 Cron Job이 표시되어야 함
   - ✅ Status: "Enabled" 확인

### 2단계: 환경 변수 설정

1. **Settings → Environment Variables**

2. **다음 변수들이 설정되어 있는지 확인:**

   ```
   NEXT_PUBLIC_SUPABASE_URL
   NEXT_PUBLIC_SUPABASE_ANON_KEY
   SUPABASE_SERVICE_KEY
   CRON_SECRET
   ```

3. **없으면 추가:**
   - Key: `CRON_SECRET`
   - Value: `a8f4c2d1b9e7f6a3c5d8e2b4f7a9c1d3e5f8a2b6c9d4e7f1a3b8c5d9e2f6a4b7`
   - Environment: Production, Preview, Development (모두 선택)

### 3단계: 재배포

환경 변수 추가 후:
- **Deployments → 최신 배포 → Redeploy**

---

## 📊 데이터 수집 프로세스

### 매일 밤 23:00 (재무 데이터)

```
23:00 - Vercel Cron 실행
  ↓
/api/collect-data 호출
  ↓
1. KOSPI 500개 기업 목록 수집
2. KOSDAQ 500개 기업 목록 수집
  ↓
각 기업별로:
  - FnGuide에서 컨센서스 데이터 수집
  - 최근 4개년도 매출/영업이익 저장
  - 증감률 자동 계산
  ↓
Supabase에 저장
  ↓
자동으로 View 갱신 (mv_consensus_changes)
```

**소요 시간:** 약 20-30분 (1,000개 기업)

### 평일 저녁 20:00 (주가 데이터)

```
20:00 - Vercel Cron 실행 (월-금만)
  ↓
/api/collect-daily-prices 호출
  ↓
DB에서 모든 기업 목록 조회
  ↓
각 기업별로:
  - 네이버 증권에서 최신 종가 수집
  - 등락률, 거래량 저장
  ↓
Supabase에 저장
  ↓
120일 이동평균 자동 계산
```

**소요 시간:** 약 5-7분 (1,000개 기업)

---

## 🔍 수집 상태 모니터링

### 방법 1: Vercel Logs

1. **Vercel Dashboard → 프로젝트 → Logs**
2. **Function Logs 필터**
3. **검색어:**
   - `/api/collect-data`
   - `/api/collect-daily-prices`

### 방법 2: Supabase에서 직접 확인

```sql
-- 오늘 수집된 재무 데이터 확인
SELECT 
  scrape_date,
  COUNT(DISTINCT company_id) as company_count,
  COUNT(*) as total_records
FROM financial_data
WHERE scrape_date = CURRENT_DATE
GROUP BY scrape_date;

-- 오늘 수집된 주가 데이터 확인
SELECT 
  date,
  COUNT(DISTINCT company_id) as company_count,
  COUNT(*) as total_records
FROM daily_stock_prices
WHERE date = CURRENT_DATE
GROUP BY date;
```

### 방법 3: 웹 페이지에서 확인

```
https://your-project.vercel.app/investment-finder
```

- "마지막 업데이트" 날짜 확인
- 기업 목록이 최신 데이터인지 확인

---

## 🔧 수동 데이터 수집 (필요시)

### 로컬에서 테스트

```bash
cd /home/user/webapp
npm run dev
```

브라우저에서:
```
http://localhost:3000/api/collect-data?secret=a8f4c2d1b9e7f6a3c5d8e2b4f7a9c1d3e5f8a2b6c9d4e7f1a3b8c5d9e2f6a4b7
```

또는:
```
http://localhost:3000/api/collect-daily-prices?secret=a8f4c2d1b9e7f6a3c5d8e2b4f7a9c1d3e5f8a2b6c9d4e7f1a3b8c5d9e2f6a4b7
```

### Vercel에서 수동 실행

```bash
# 재무 데이터 수집
curl "https://your-project.vercel.app/api/collect-data?secret=a8f4c2d1b9e7f6a3c5d8e2b4f7a9c1d3e5f8a2b6c9d4e7f1a3b8c5d9e2f6a4b7"

# 주가 데이터 수집
curl "https://your-project.vercel.app/api/collect-daily-prices?secret=a8f4c2d1b9e7f6a3c5d8e2b4f7a9c1d3e5f8a2b6c9d4e7f1a3b8c5d9e2f6a4b7"
```

---

## 📈 View 자동 갱신

데이터가 수집될 때마다 자동으로:

1. **mv_consensus_changes** - 컨센서스 변화율 계산
   - 1일 전 대비
   - 1개월 전 대비

2. **mv_stock_analysis** - 투자 점수 계산
   - 컨센서스 점수
   - 가격 이격도
   - 종합 점수

**갱신 방법:**
- 데이터 추가 시 자동
- 또는 Supabase에서 수동:
  ```sql
  REFRESH MATERIALIZED VIEW CONCURRENTLY mv_consensus_changes;
  REFRESH MATERIALIZED VIEW CONCURRENTLY mv_stock_analysis;
  ```

---

## ⚠️ 주의사항

### 1. Rate Limiting

**FnGuide:**
- 1초당 1개 기업
- 1,000개 기업 = 약 20분
- 안전한 속도 유지 중

**네이버 증권:**
- 배치 처리 (10개씩)
- 1초 대기
- 안전한 속도 유지 중

### 2. Vercel 제한사항

**Pro Plan:**
- 함수 실행 시간: 최대 5분 (300초)
- 배치 처리로 분할 실행

**Free Plan (주의!):**
- 함수 실행 시간: 최대 10초
- Cron Job 제한 있음
- → Pro Plan 권장!

### 3. 데이터 품질

**누락 데이터 처리:**
- 스크래핑 실패 시 NULL 저장
- 다음 수집 때 재시도
- View에서 자동 필터링

---

## 🎯 완전 자동화 체크리스트

- [ ] Vercel에 배포 완료
- [ ] Vercel Pro Plan 활성화 (권장)
- [ ] 환경 변수 설정 완료
  - [ ] SUPABASE_SERVICE_KEY
  - [ ] CRON_SECRET
- [ ] Cron Job 활성화 확인
- [ ] 첫 수집 수동 실행 및 테스트
- [ ] Vercel Logs에서 성공 확인
- [ ] Supabase에서 데이터 확인
- [ ] 웹 페이지에서 결과 확인

---

## 📊 데이터 수집 일정

| 시간 | 작업 | 대상 | 소요 시간 |
|------|------|------|-----------|
| **평일 20:00** | 주가 수집 | 모든 기업 | 5-7분 |
| **매일 23:00** | 재무 수집 | 1,000개 기업 | 20-30분 |

**타임라인:**
```
월요일:
20:00 - 주가 수집 ✅
23:00 - 재무 수집 ✅

화요일:
20:00 - 주가 수집 ✅
23:00 - 재무 수집 ✅

수요일:
20:00 - 주가 수집 ✅
23:00 - 재무 수집 ✅

목요일:
20:00 - 주가 수집 ✅
23:00 - 재무 수집 ✅

금요일:
20:00 - 주가 수집 ✅
23:00 - 재무 수집 ✅

주말:
23:00 - 재무 수집 ✅ (주말에도 컨센서스 업데이트 모니터링)
```

---

## 🔄 View 갱신 스케줄

**자동 갱신:** 새 데이터 수집 시마다

**수동 갱신 (필요시):**
```sql
-- Supabase SQL Editor에서 실행
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_consensus_changes;
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_stock_analysis;
```

---

## 🎉 완전 자동화 후 기대 효과

### 매일 자동으로:
- ✅ 1,000개 기업 컨센서스 업데이트
- ✅ 평일 주가 데이터 수집
- ✅ 증감률 자동 계산
- ✅ 투자 기회 자동 발견
- ✅ 웹에서 바로 확인 가능

### 사용자는:
- 📱 언제든 웹사이트 접속
- 🔍 최신 투자 기회 확인
- 📊 과거 변화 추적
- 🎯 조건 필터링으로 원하는 기업 발견

---

## 🆘 문제 해결

### Cron이 실행 안 될 때:
1. Vercel Pro Plan인지 확인
2. 환경 변수 확인
3. Vercel Logs 확인
4. CRON_SECRET 일치 확인

### 데이터가 수집 안 될 때:
1. API 엔드포인트 수동 호출 테스트
2. Supabase 연결 확인
3. Rate Limiting 확인
4. Vercel Logs에서 에러 확인

---

## 📞 다음 단계

1. **Vercel 재배포** (최신 코드 적용)
2. **Cron Job 확인** (Dashboard에서)
3. **환경 변수 확인**
4. **첫 수집 수동 실행** (테스트)
5. **내일부터 자동 수집 시작!**

---

**모든 것이 설정되어 있습니다! Vercel에 배포만 하면 자동으로 매일 데이터가 수집됩니다!** 🚀

**오늘 밤 23:00부터 자동 수집이 시작될 것입니다!** ⏰
