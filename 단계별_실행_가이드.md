# ğŸ› ï¸ ë‹¨ê³„ë³„ ì‹¤í–‰ ê°€ì´ë“œ

## âš ï¸ ì´ì „ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì—ëŸ¬ ë°œìƒ

**ì—ëŸ¬ ì›ì¸:**
```
ERROR: column sa.revenue_growth_1month does not exist
```

ì´ ì—ëŸ¬ëŠ” `mv_stock_analysis` materialized viewê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ì»¬ëŸ¼ êµ¬ì¡°ê°€ ë‹¤ë¥´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

**í•´ê²°ì±…:** ë” ì•ˆì „í•œ ë‹¨ìˆœ ë²„ì „ ìŠ¤í¬ë¦½íŠ¸ ì‚¬ìš©

---

## ğŸ“ ìƒˆë¡œìš´ ì‹¤í–‰ ë°©ë²• (2ë‹¨ê³„)

### 1ë‹¨ê³„: ë°ì´í„° ì •ê·œí™” (í•„ìˆ˜)

#### íŒŒì¼: `scripts/fix-data-scale-simple.sql`

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ”:
- âœ… View ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì—†ì´ ì‹¤í–‰ ê°€ëŠ¥
- âœ… ë°ì´í„°ë§Œ ì •ê·œí™” (Ã· 100,000,000)
- âœ… ìë™ ë°±ì—… ìƒì„±
- âœ… ì „/í›„ ë¹„êµ í™•ì¸

#### Supabaseì—ì„œ ì‹¤í–‰:

1. **SQL Editor ì—´ê¸°**
   - https://supabase.com/dashboard
   - í”„ë¡œì íŠ¸ ì„ íƒ â†’ "SQL Editor"

2. **ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬**
   ```bash
   íŒŒì¼ ìœ„ì¹˜: /home/user/webapp/scripts/fix-data-scale-simple.sql
   ```

3. **ë¶™ì—¬ë„£ê¸° í›„ "Run" í´ë¦­**

4. **ê²°ê³¼ í™•ì¸**
   - "BEFORE FIX" ê²°ê³¼: í° ìˆ«ì (ì˜ˆ: 300,870,900,000,000)
   - "AFTER FIX" ê²°ê³¼: ì‘ì€ ìˆ«ì (ì˜ˆ: 3,008,709)
   - "values_similar" = TRUE í™•ì¸

---

### 2ë‹¨ê³„: View ê°±ì‹  (ì„ íƒì‚¬í•­)

#### íŒŒì¼: `scripts/refresh-views-if-exist.sql`

ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ”:
- âœ… Materialized View ì¡´ì¬ í™•ì¸
- âœ… ìˆì„ ê²½ìš°ì—ë§Œ ê°±ì‹ 

#### Supabaseì—ì„œ ì‹¤í–‰:

1. **ë™ì¼í•œ SQL Editorì—ì„œ**

2. **ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬**
   ```bash
   íŒŒì¼ ìœ„ì¹˜: /home/user/webapp/scripts/refresh-views-if-exist.sql
   ```

3. **ë¶™ì—¬ë„£ê¸° í›„ "Run" í´ë¦­**

4. **ê²°ê³¼ í™•ì¸**
   - `pg_matviews` í…Œì´ë¸”ì— view ëª©ë¡ í‘œì‹œë¨
   - ë§Œì•½ `mv_consensus_changes`, `mv_stock_analysis`ê°€ ë³´ì´ë©´:
     - ìŠ¤í¬ë¦½íŠ¸ì—ì„œ `--` ì£¼ì„ ì œê±°
     - `REFRESH MATERIALIZED VIEW ...` ë¼ì¸ í™œì„±í™”
     - ë‹¤ì‹œ ì‹¤í–‰

---

## ğŸ“Š ì˜ˆìƒ ê²°ê³¼

### 1ë‹¨ê³„ ì‹¤í–‰ í›„ (fix-data-scale-simple.sql)

```sql
-- BEFORE FIX
scrape_date   | year | revenue              | operating_profit
2025-10-25    | 2024 | 3008709             | 327260
2025-10-23    | 2024 | 3008709             | 327260
2025-10-10    | 2024 | 300870900000000     | 32726000000000  â† ë¬¸ì œ!

-- AFTER FIX
scrape_date   | year | revenue     | operating_profit
2025-10-25    | 2024 | 3008709    | 327260
2025-10-23    | 2024 | 3008709    | 327260
2025-10-10    | 2024 | 3008709    | 327260          â† ì •ê·œí™” ì™„ë£Œ! âœ…
```

### 2ë‹¨ê³„ ì‹¤í–‰ í›„ (refresh-views-if-exist.sql)

```sql
-- Materialized Views ëª©ë¡
schemaname | matviewname           | definition
public     | mv_consensus_changes  | SELECT ...
public     | mv_stock_analysis     | SELECT ...
```

---

## ğŸ” ë¬¸ì œ í•´ê²°

### ë§Œì•½ 1ë‹¨ê³„ì—ì„œë„ ì—ëŸ¬ê°€ ë‚˜ë©´:

#### ì—ëŸ¬ 1: `table financial_data does not exist`
```sql
-- í…Œì´ë¸” í™•ì¸
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public';
```

#### ì—ëŸ¬ 2: `permission denied`
```sql
-- ê¶Œí•œ í™•ì¸ (Service Role Key ì‚¬ìš© í•„ìš”)
SELECT current_user, current_database();
```

---

## âœ… ì„±ê³µ í™•ì¸ ë°©ë²•

### ë°©ë²• 1: SQL ì§ì ‘ í™•ì¸
```sql
-- ìµœê·¼ ë°ì´í„°ì™€ ê³¼ê±° ë°ì´í„° ë¹„êµ
SELECT 
  scrape_date,
  year,
  revenue,
  operating_profit
FROM financial_data
WHERE company_id = 1 
  AND year = '2024'
ORDER BY scrape_date DESC
LIMIT 5;
```

**ê¸°ëŒ€ ê²°ê³¼:** ëª¨ë“  revenue ê°’ì´ ë¹„ìŠ·í•œ í¬ê¸° (ì˜ˆ: 3,000,000 ~ 3,100,000)

### ë°©ë²• 2: ì›¹ í˜ì´ì§€ í™•ì¸

1. **ê°œë°œ ì„œë²„ ì‹¤í–‰**
   ```bash
   cd /home/user/webapp
   npm run dev
   ```

2. **íˆ¬ìê¸°íšŒ ë°œê²¬ í˜ì´ì§€ ì—´ê¸°**
   ```
   http://localhost:3000/investment-finder
   ```

3. **í™•ì¸ ì‚¬í•­**
   - âœ… ê¸°ì—…ë³„ ì ìˆ˜ê°€ ë‹¤ì–‘í•œê°€? (0~100ì  ë¶„í¬)
   - âœ… ì¦ê°ë¥ ì´ í˜„ì‹¤ì ì¸ê°€? (-10% ~ +20% ë²”ìœ„)
   - âœ… í•„í„°ê°€ ì‘ë™í•˜ëŠ”ê°€?

---

## ğŸ†˜ ì—¬ì „íˆ ë¬¸ì œê°€ ìˆë‹¤ë©´?

### ì˜µì…˜ 1: ë°±ì—…ì—ì„œ ë³µì›
```sql
-- ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ê¸°
DELETE FROM financial_data WHERE scrape_date < '2025-10-25';
INSERT INTO financial_data SELECT * FROM financial_data_backup;
```

### ì˜µì…˜ 2: ìƒíƒœ ê³µìœ 
ë‹¤ìŒ ì •ë³´ë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”:
1. ì—ëŸ¬ ë©”ì‹œì§€ ì „ì²´
2. ì‹¤í–‰í•œ ìŠ¤í¬ë¦½íŠ¸ (1ë‹¨ê³„ or 2ë‹¨ê³„)
3. `SELECT COUNT(*) FROM financial_data;` ê²°ê³¼

---

## ğŸ“ íŒŒì¼ ìš”ì•½

| íŒŒì¼ | ìš©ë„ | í•„ìˆ˜ ì—¬ë¶€ |
|------|------|----------|
| `fix-data-scale-simple.sql` | ë°ì´í„° ì •ê·œí™” | âœ… í•„ìˆ˜ |
| `refresh-views-if-exist.sql` | View ê°±ì‹  | âš ï¸ View ìˆìœ¼ë©´ í•„ìˆ˜ |
| `fix-data-scale.sql` (ì´ì „) | âŒ ì‚¬ìš© ì•ˆ í•¨ | ì—ëŸ¬ ë°œìƒ |

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. âœ… **`fix-data-scale-simple.sql` ì‹¤í–‰** (ë¨¼ì €!)
2. âœ… **ê²°ê³¼ í™•ì¸** (BEFORE/AFTER ë¹„êµ)
3. âœ… **`refresh-views-if-exist.sql` ì‹¤í–‰** (View ìˆìœ¼ë©´)
4. âœ… **ì›¹ í˜ì´ì§€ í…ŒìŠ¤íŠ¸**

---

**ì˜ˆìƒ ì†Œìš” ì‹œê°„:** 5ë¶„  
**ìœ„í—˜ë„:** ğŸŸ¢ ë‚®ìŒ (ìë™ ë°±ì—…)  
**ìš°ì„ ìˆœìœ„:** ğŸš¨ ê¸´ê¸‰

í™”ì´íŒ…! ğŸš€
