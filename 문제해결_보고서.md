# 🚨 중대한 버그 발견 및 해결 방안

## 📋 요약

**문제:** 모든 기업이 100점으로 표시되며, 컨센서스 변화가 -100% 또는 +100%로만 나타남

**원인 규명 완료:** ✅ **데이터 단위 불일치** (100,000,000배 차이)

**해결 방안 준비 완료:** ✅ SQL 마이그레이션 스크립트 작성

---

## 🔍 조사 과정

### 1단계: 초기 가설
- View 로직이 `GREATEST()` 함수를 사용해서 점수가 잘못 계산되는 것으로 추정
- fix-view-simple.sql 작성하여 평균 계산으로 수정 시도

### 2단계: 데이터 존재 확인
- 사용자님 말씀: "과거 데이터를 이미 저장했었다"
- `/app/api/check-all-dates/route.ts` 생성하여 확인
- **결과:** 141,505개 레코드, 71개의 서로 다른 날짜 확인!

### 3단계: 결정적 증거 발견
- 사용자님이 제공한 SQL 쿼리 결과:
  ```
  2025-10-25: revenue = 4933
  2025-10-10: revenue = 493300000000
  ```
- **차이:** 약 100,000,000배 (정확히 1억 배)

### 4단계: 원인 규명
- 디버그 API 생성하여 정확한 스케일 확인
- **삼성전자 2024년 매출액 비교:**
  - 최신 데이터 (2025-10-25): `3,008,709` (억원 단위)
  - 과거 데이터 (2025-07-09): `300,870,900,000,000` (원 단위)
  - **스케일 차이:** 정확히 100,000,000배

---

## 💡 문제의 본질

### 구 스크래퍼 (2025-10-25 이전)
```javascript
// original-scripts/1_seoul_ys_fnguide.js
const revenue = parseFloat(revenueStr.replace(/,/g, ''));
// FnGuide에서 가져온 값을 원(won) 단위 그대로 저장
```

### 신 스크래퍼 (2025-10-25 이후)
```typescript
// lib/scraper-fnguide.ts
export interface FinancialYearData {
  revenue: number | null;  // 매출액 (억원) <- 주석에 억원이라고 명시!
}
// 값을 억원(hundred millions) 단위로 해석하여 저장
```

### 왜 -100%가 나오는가?

View에서 증감률 계산 시:
```sql
(신규값 - 과거값) / 과거값 * 100

= (3,008,709 - 300,870,900,000,000) / 300,870,900,000,000 * 100
≈ -100%
```

모든 비교에서 신규값이 과거값의 1억분의 1이므로 무조건 -100% 또는 +100%가 나옵니다!

---

## 🛠️ 해결 방안

### 해결책: 과거 데이터를 억원 단위로 정규화

**과거 데이터를 100,000,000으로 나누어 억원 단위로 변환**

### 실행 방법

1. **Supabase 대시보드 접속**
   - https://supabase.com/dashboard
   - 프로젝트 선택
   - 왼쪽 메뉴에서 "SQL Editor" 클릭

2. **마이그레이션 스크립트 실행**
   - 파일 위치: `/home/user/webapp/scripts/fix-data-scale.sql`
   - 파일 내용을 복사하여 SQL Editor에 붙여넣기
   - "Run" 버튼 클릭

3. **스크립트 실행 내용**
   ```sql
   -- 1. 백업 테이블 생성 (안전장치)
   CREATE TABLE financial_data_backup AS ...
   
   -- 2. 업데이트할 레코드 수 확인
   SELECT COUNT(*) FROM financial_data WHERE scrape_date < '2025-10-25';
   
   -- 3. 과거 데이터 정규화 (100,000,000으로 나누기)
   UPDATE financial_data
   SET revenue = revenue / 100000000.0,
       operating_profit = operating_profit / 100000000.0
   WHERE scrape_date < '2025-10-25';
   
   -- 4. Materialized View 갱신
   REFRESH MATERIALIZED VIEW CONCURRENTLY mv_consensus_changes;
   REFRESH MATERIALIZED VIEW CONCURRENTLY mv_stock_analysis;
   
   -- 5. 결과 확인
   SELECT * FROM mv_stock_analysis LIMIT 10;
   ```

---

## ✅ 예상 결과

### 수정 전
```
🔴 모든 기업: 점수 100점
   - 매출 증감률 1개월: -100%
   - 영업이익 증감률 1개월: +100%
   또는
   - 매출 증감률 1개월: +100%
   - 영업이익 증감률 1개월: -100%
```

### 수정 후
```
🟢 기업 A: 점수 82점
   - 매출 증감률 1개월: +5.2%
   - 영업이익 증감률 1개월: +3.8%

🟡 기업 B: 점수 45점
   - 매출 증감률 1개월: +1.2%
   - 영업이익 증감률 1개월: -2.1%

🟢 기업 C: 점수 75점
   - 매출 증감률 1개월: +8.5%
   - 영업이익 증감률 1개월: +7.3%
```

---

## 📊 영향 범위

### 수정 대상 데이터
- **전체 레코드:** 141,505개
- **수정할 레코드:** ~140,661개 (2025-10-25 이전)
- **정상 레코드:** ~844개 (2025-10-25 이후)
- **기간:** 2025-07-09 ~ 2025-10-24

### 영향받는 기능
1. ❌ 투자기회 발견 페이지 - 모든 기업 100점
2. ❌ 컨센서스 변화 추적 - 모두 -100%/+100%
3. ❌ 증감률 계산 - 완전히 부정확
4. ❌ 과거 데이터 비교 - 사용 불가

---

## 🔒 안전 장치

### 백업 생성
```sql
CREATE TABLE financial_data_backup AS 
SELECT * FROM financial_data 
WHERE scrape_date < '2025-10-25';
```

### 롤백 방법 (문제 발생 시)
```sql
DELETE FROM financial_data WHERE scrape_date < '2025-10-25';
INSERT INTO financial_data SELECT * FROM financial_data_backup;
```

---

## 📁 생성된 파일

1. **`scripts/fix-data-scale.sql`**
   - 실행할 마이그레이션 SQL 스크립트
   - 백업, 업데이트, 검증 포함

2. **`DATA_SCALE_FIX_GUIDE.md`**
   - 영문 상세 가이드
   - 단계별 실행 방법

3. **`CRITICAL_BUG_FOUND.md`**
   - 영문 조사 보고서
   - 기술적 세부사항

4. **`app/api/debug-data-scale/route.ts`**
   - 디버그 API 엔드포인트
   - 스케일 차이 확인용

---

## 🎯 다음 단계

1. **Supabase SQL Editor에서 스크립트 실행** ⭐ 가장 중요!
   
2. **결과 확인**
   - 삼성전자 데이터가 일관된 단위로 표시되는지 확인
   - 증감률이 현실적인 값(예: -5% ~ +10%)인지 확인
   - 점수가 다양하게 분포(0~100)하는지 확인

3. **투자기회 발견 페이지 테스트**
   - http://localhost:3000/investment-finder 접속
   - 기업들이 다양한 점수를 보이는지 확인
   - 필터가 정상 작동하는지 확인

4. **결과 공유**
   - 수정 후 화면 캡처 또는 결과 공유
   - 추가 문제 발견 시 알려주세요

---

## ⏱️ 예상 소요 시간

- **스크립트 실행:** 2-5분
- **View 갱신:** 1-2분
- **테스트 및 확인:** 5분

**총 예상 시간: 10분 이내**

---

## 🎓 교훈

1. **데이터 단위를 명확히** - 주석과 스키마에 단위 명시
2. **데이터 일관성 검증** - 마이그레이션 시 스케일 확인
3. **실제 데이터로 테스트** - 합성 데이터는 이런 문제를 못 잡음
4. **백업은 필수** - 항상 안전장치 준비
5. **철저한 조사** - 명백해 보이는 답이 항상 맞는 건 아님

---

## ❓ 질문이나 문제 발생 시

1. **백업 확인:**
   ```sql
   SELECT COUNT(*) FROM financial_data_backup;
   ```

2. **현재 상태 확인:**
   ```sql
   SELECT scrape_date, revenue FROM financial_data 
   WHERE company_id = 1 AND year = '2024' 
   ORDER BY scrape_date DESC LIMIT 5;
   ```

3. **View 상태 확인:**
   ```sql
   SELECT company_id, consensus_score, revenue_growth_1month 
   FROM mv_stock_analysis 
   WHERE revenue_growth_1month IS NOT NULL 
   LIMIT 10;
   ```

---

**상태:** ✅ 버그 원인 규명 완료, 수정 스크립트 준비 완료

**우선순위:** 🚨 긴급 - 이 문제를 해결해야 시스템이 정상 작동합니다

**리스크:** 🟢 낮음 - 백업 생성, 롤백 가능

**다음 액션:** Supabase에서 `fix-data-scale.sql` 실행하시면 됩니다! 🚀
