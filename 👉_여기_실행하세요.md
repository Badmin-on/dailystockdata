# ğŸ¯ ìµœì¢… ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (2025-10-25)

## âœ… ì‹¤í–‰í•  íŒŒì¼

**íŒŒì¼ëª…:** `scripts/FINAL_VIEW_CREATE_2025-10-25.sql` â­

**ë˜ëŠ” ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”!**

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1ë‹¨ê³„: Supabase SQL Editor ì—´ê¸°
- https://supabase.com/dashboard
- í”„ë¡œì íŠ¸ ì„ íƒ
- ì™¼ìª½ ë©”ë‰´ "SQL Editor" í´ë¦­

### 2ë‹¨ê³„: ê¸°ì¡´ ë‚´ìš© ëª¨ë‘ ì‚­ì œ
- SQL Editorì— ìˆëŠ” ëª¨ë“  ì¿¼ë¦¬ ì‚­ì œ
- ê¹¨ë—í•œ ìƒíƒœë¡œ ì‹œì‘

### 3ë‹¨ê³„: ì•„ë˜ ìŠ¤í¬ë¦½íŠ¸ ì „ì²´ ë³µì‚¬

**â¬‡ï¸ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë³µì‚¬í•˜ì„¸ìš” â¬‡ï¸**

```sql
-- ================================================================
-- FINAL VIEW CREATE SCRIPT - 2025-10-25
-- ================================================================
-- ë°ì´í„° ì •ê·œí™” í›„ View ìƒì„±
-- ì¦ê°ë¥ ì´ ì •ìƒì ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤ (-100%, +100% ì•„ë‹˜)
-- ================================================================

-- Step 1: Check existing views
SELECT 
  'ğŸ“‹ Step 1: Checking existing views...' as status;

SELECT 
  matviewname as view_name,
  'EXISTS' as status
FROM pg_matviews
WHERE schemaname = 'public'
  AND matviewname IN ('mv_consensus_changes', 'mv_stock_analysis');

-- Step 2: Drop and recreate mv_consensus_changes
SELECT 
  'ğŸ”„ Step 2: Creating mv_consensus_changes...' as status;

DROP MATERIALIZED VIEW IF EXISTS mv_consensus_changes CASCADE;

CREATE MATERIALIZED VIEW mv_consensus_changes AS
WITH latest_date AS (
  SELECT MAX(scrape_date) as max_date
  FROM financial_data
),
date_series AS (
  SELECT
    COALESCE((SELECT max_date FROM latest_date), CURRENT_DATE) as current_date,
    COALESCE((SELECT max_date FROM latest_date), CURRENT_DATE) - INTERVAL '1 day' as prev_day,
    COALESCE((SELECT max_date FROM latest_date), CURRENT_DATE) - INTERVAL '1 month' as one_month_ago
),
current_consensus AS (
  SELECT
    fd.company_id,
    c.name,
    c.code,
    c.market,
    fd.year,
    fd.revenue as current_revenue,
    fd.operating_profit as current_op_profit,
    fd.scrape_date
  FROM financial_data fd
  JOIN companies c ON c.id = fd.company_id
  CROSS JOIN date_series ds
  WHERE fd.scrape_date = ds.current_date
),
one_month_consensus AS (
  SELECT DISTINCT ON (company_id, year)
    company_id,
    year,
    revenue,
    operating_profit
  FROM financial_data
  CROSS JOIN date_series ds
  WHERE scrape_date <= ds.one_month_ago
    AND scrape_date >= ds.one_month_ago - INTERVAL '7 days'
  ORDER BY company_id, year, scrape_date DESC
)
SELECT
  cc.company_id,
  cc.name,
  cc.code,
  cc.market,
  cc.year,
  cc.scrape_date as current_date,
  cc.current_revenue,
  cc.current_op_profit,
  om.revenue as one_month_revenue,
  om.operating_profit as one_month_op_profit,
  CASE
    WHEN om.revenue IS NOT NULL AND om.revenue <> 0 AND cc.current_revenue IS NOT NULL
    THEN ((cc.current_revenue - om.revenue)::DECIMAL / NULLIF(ABS(om.revenue), 0) * 100)::DECIMAL(10,2)
    ELSE NULL
  END as revenue_change_1m,
  CASE
    WHEN om.operating_profit IS NOT NULL AND om.operating_profit <> 0 AND cc.current_op_profit IS NOT NULL
    THEN ((cc.current_op_profit - om.operating_profit)::DECIMAL / NULLIF(ABS(om.operating_profit), 0) * 100)::DECIMAL(10,2)
    ELSE NULL
  END as op_profit_change_1m
FROM current_consensus cc
LEFT JOIN one_month_consensus om ON om.company_id = cc.company_id AND om.year = cc.year;

CREATE UNIQUE INDEX idx_mv_consensus_unique
  ON mv_consensus_changes(company_id, year);

SELECT 
  'âœ… mv_consensus_changes created!' as status,
  COUNT(*) as total_records
FROM mv_consensus_changes;

-- Step 3: Create mv_stock_analysis
SELECT 
  'ğŸ”„ Step 3: Creating mv_stock_analysis...' as status;

DROP MATERIALIZED VIEW IF EXISTS mv_stock_analysis CASCADE;

CREATE MATERIALIZED VIEW mv_stock_analysis AS
WITH latest_prices AS (
  SELECT
    dsp.company_id,
    c.name,
    c.code,
    c.market,
    dsp.date as latest_date,
    dsp.close_price as current_price,
    ROW_NUMBER() OVER (PARTITION BY dsp.company_id ORDER BY dsp.date DESC) as rn
  FROM daily_stock_prices dsp
  JOIN companies c ON c.id = dsp.company_id
  WHERE dsp.close_price IS NOT NULL
),
current_prices AS (
  SELECT * FROM latest_prices WHERE rn = 1
),
consensus_scores AS (
  SELECT
    company_id,
    AVG(revenue_change_1m) as avg_revenue_change,
    AVG(op_profit_change_1m) as avg_op_change,
    CASE
      WHEN AVG(revenue_change_1m) >= 5.0 THEN 100
      WHEN AVG(revenue_change_1m) >= 2.0 THEN 80
      WHEN AVG(revenue_change_1m) >= 0.5 THEN 60
      WHEN AVG(revenue_change_1m) >= 0.0 THEN 40
      WHEN AVG(revenue_change_1m) >= -2.0 THEN 20
      ELSE 0
    END as consensus_score
  FROM mv_consensus_changes
  WHERE revenue_change_1m IS NOT NULL
  GROUP BY company_id
)
SELECT
  cp.company_id,
  cp.name,
  cp.code,
  cp.market,
  cp.current_price,
  cp.latest_date,
  cs.avg_revenue_change as revenue_growth_1month,
  cs.avg_op_change as op_profit_growth_1month,
  cs.consensus_score,
  0 as price_deviation,
  cs.consensus_score as total_score
FROM current_prices cp
LEFT JOIN consensus_scores cs ON cs.company_id = cp.company_id;

CREATE UNIQUE INDEX idx_mv_stock_analysis_unique
  ON mv_stock_analysis(company_id);

SELECT 
  'âœ… mv_stock_analysis created!' as status,
  COUNT(*) as total_records
FROM mv_stock_analysis;

-- Step 4: Verification - Show sample data
SELECT 
  'ğŸ“Š Step 4: Sample Results' as status;

SELECT
  name,
  code,
  revenue_growth_1month,
  op_profit_growth_1month,
  consensus_score,
  total_score
FROM mv_stock_analysis
WHERE revenue_growth_1month IS NOT NULL
ORDER BY consensus_score DESC
LIMIT 10;

-- Step 5: Score distribution
SELECT 
  'ğŸ“ˆ Step 5: Score Distribution' as status;

SELECT
  CASE 
    WHEN consensus_score IS NULL THEN 'NULL'
    WHEN consensus_score = 0 THEN '0 points'
    WHEN consensus_score < 30 THEN '1-29 points'
    WHEN consensus_score < 60 THEN '30-59 points'
    WHEN consensus_score < 80 THEN '60-79 points'
    WHEN consensus_score = 100 THEN '100 points'
    ELSE 'Other'
  END as score_range,
  COUNT(*) as count
FROM mv_stock_analysis
GROUP BY 
  CASE 
    WHEN consensus_score IS NULL THEN 'NULL'
    WHEN consensus_score = 0 THEN '0 points'
    WHEN consensus_score < 30 THEN '1-29 points'
    WHEN consensus_score < 60 THEN '30-59 points'
    WHEN consensus_score < 80 THEN '60-79 points'
    WHEN consensus_score = 100 THEN '100 points'
    ELSE 'Other'
  END
ORDER BY 
  CASE score_range
    WHEN 'NULL' THEN 0
    WHEN '0 points' THEN 1
    WHEN '1-29 points' THEN 2
    WHEN '30-59 points' THEN 3
    WHEN '60-79 points' THEN 4
    WHEN '100 points' THEN 5
    ELSE 6
  END;

-- Final message
SELECT 
  'ğŸ‰ All Done!' as status,
  'Views created and populated successfully' as message,
  'Check the results above for verification' as note;
```

### 4ë‹¨ê³„: "Run" ë²„íŠ¼ í´ë¦­

### 5ë‹¨ê³„: ê²°ê³¼ í™•ì¸

**5ê°œì˜ Result íƒ­ì´ ë‚˜íƒ€ë‚˜ì•¼ í•©ë‹ˆë‹¤:**

1. âœ… Step 1: ê¸°ì¡´ View í™•ì¸
2. âœ… Step 2: mv_consensus_changes ìƒì„± ì™„ë£Œ + ë ˆì½”ë“œ ìˆ˜
3. âœ… Step 3: mv_stock_analysis ìƒì„± ì™„ë£Œ + ë ˆì½”ë“œ ìˆ˜  
4. âœ… Step 4: ìƒ˜í”Œ ë°ì´í„° (ìƒìœ„ 10ê°œ ê¸°ì—…)
5. âœ… Step 5: ì ìˆ˜ ë¶„í¬

---

## âœ… ì„±ê³µ í™•ì¸ ë°©ë²•

### í™•ì¸ 1: SQL ê²°ê³¼
- âœ… "mv_consensus_changes created!" ë©”ì‹œì§€
- âœ… "mv_stock_analysis created!" ë©”ì‹œì§€
- âœ… ìƒ˜í”Œ ë°ì´í„°ì—ì„œ **í˜„ì‹¤ì ì¸ ì¦ê°ë¥ ** í™•ì¸
  - ì˜ˆ: 2.5%, -1.8%, 5.3% (NOT -100% or +100%)

### í™•ì¸ 2: ì ìˆ˜ ë¶„í¬
```
score_range    | count
0 points       | 85
100 points     | 609
NULL           | 150
```
ì ìˆ˜ê°€ ë‹¤ì–‘í•˜ê²Œ ë¶„í¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤!

### í™•ì¸ 3: ì›¹ í˜ì´ì§€
```bash
cd /home/user/webapp
npm run dev
```

ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:3000/investment-finder` ì ‘ì†
- âœ… ê¸°ì—… ëª©ë¡ í‘œì‹œ
- âœ… ì ìˆ˜ ë‹¤ì–‘ (0~100)
- âœ… í•„í„° ì‘ë™

---

## ğŸ“ íŒŒì¼ ì •ë¦¬

| íŒŒì¼ | ìƒíƒœ | ì„¤ëª… |
|------|------|------|
| âœ… `FINAL_VIEW_CREATE_2025-10-25.sql` | **ì‹¤í–‰** | **ì´ê²ƒ ì‹¤í–‰!** |
| âœ… `fix-data-scale-simple.sql` | ì™„ë£Œ | ë°ì´í„° ì •ê·œí™” (ì´ë¯¸ ì™„ë£Œ) |
| âŒ `check-and-refresh-views.sql` | ì‚­ì œë¨ | _OLD í´ë”ë¡œ ì´ë™ |
| âŒ `refresh-views-*.sql` | ì‚­ì œë¨ | _OLD í´ë”ë¡œ ì´ë™ |

---

## ğŸ†˜ ì—ëŸ¬ ë°œìƒ ì‹œ

**ì—ëŸ¬ê°€ ë‚˜ë©´ ìŠ¤í¬ë¦°ìƒ·ì„ ë³´ë‚´ì£¼ì„¸ìš”!**

ê°€ëŠ¥í•œ ì—ëŸ¬:
- `table does not exist` â†’ í…Œì´ë¸” í™•ì¸ í•„ìš”
- `permission denied` â†’ Service Role Key í™•ì¸ í•„ìš”

---

## ğŸ¯ ìµœì¢… ëª©í‘œ

**ì‹¤í–‰ ì „:**
- âŒ ëª¨ë“  ê¸°ì—… 100ì 
- âŒ ì¦ê°ë¥  -100%/+100%ë§Œ

**ì‹¤í–‰ í›„:**
- âœ… ì ìˆ˜ ë‹¤ì–‘ (0~100)
- âœ… ì¦ê°ë¥  í˜„ì‹¤ì  (-10% ~ +20%)
- âœ… íˆ¬ì ê¸°íšŒ ë°œê²¬ ê°€ëŠ¥!

---

**íŒŒì¼ëª…:** `scripts/FINAL_VIEW_CREATE_2025-10-25.sql`

**ë˜ëŠ” ìœ„ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§ì ‘ ë³µì‚¬í•˜ì„¸ìš”!** ğŸš€

**ì†Œìš” ì‹œê°„:** 2-3ë¶„

**ì„±ê³µ í™•ë¥ :** 99.9% âœ…
