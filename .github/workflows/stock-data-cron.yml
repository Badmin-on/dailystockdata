name: Stock Data Auto Update

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ì˜¤ì „ 7ì‹œ = UTC 22ì‹œ (ì „ë‚ )
    - cron: '0 22 * * *'
    # í•œêµ­ ì‹œê°„ ì˜¤ì „ 8ì‹œ = UTC 23ì‹œ (ì „ë‚ )
    - cron: '0 23 * * *'
    # í•œêµ­ ì‹œê°„ ì˜¤í›„ 7ì‹œ = UTC 10ì‹œ
    - cron: '0 10 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì¶”ê°€
  workflow_dispatch:
    inputs:
      scraper_type:
        description: 'ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ ì„ íƒ'
        required: true
        type: choice
        options:
          - fnguide
          - consensus
          - stock-price
          - all

jobs:
  # Job 1: FnGuide ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ (ì˜¤ì „ 7ì‹œ)
  fnguide-scraper:
    name: FnGuide Financial Data Collection
    runs-on: ubuntu-latest
    # ì¡°ê±´: ì˜¤ì „ 7ì‹œ ìŠ¤ì¼€ì¤„(UTC 22:00) ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰(fnguide/all)
    if: |
      github.event.schedule == '0 22 * * *' ||
      github.event.inputs.scraper_type == 'fnguide' ||
      github.event.inputs.scraper_type == 'all'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run FnGuide scraper
        working-directory: ./scripts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        run: |
          echo "ğŸš€ FnGuide ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘..."
          node fnguide-scraper.js
          echo "âœ… FnGuide ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!"
          echo "â„¹ï¸ mv_stock_analysisëŠ” Regular Viewë¡œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤."

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fnguide-scraper-logs-${{ github.run_number }}
          path: scripts/*.log
          retention-days: 7

  # Job 2: ì»¨ì„¼ì„œìŠ¤ ì§€í‘œ ê³„ì‚° (ì˜¤ì „ 8ì‹œ - FnGuide ì´í›„)
  consensus-calculator:
    name: Consensus Metrics Calculation
    runs-on: ubuntu-latest
    needs: [fnguide-scraper]
    # ì¡°ê±´: ì˜¤ì „ 8ì‹œ ìŠ¤ì¼€ì¤„(UTC 23:00) ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰(consensus/all)
    # FnGuide scraperê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: |
      (github.event.schedule == '0 23 * * *' ||
       github.event.inputs.scraper_type == 'consensus' ||
       github.event.inputs.scraper_type == 'all') &&
      (needs.fnguide-scraper.result == 'success' || needs.fnguide-scraper.result == 'skipped')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run consensus calculator
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        run: |
          echo "ğŸš€ ì»¨ì„¼ì„œìŠ¤ ì§€í‘œ ê³„ì‚° ì‹œì‘..."
          npx tsx scripts/calculate-consensus-batch.ts
          echo "âœ… ì»¨ì„¼ì„œìŠ¤ ì§€í‘œ ê³„ì‚° ì™„ë£Œ!"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: consensus-calculator-logs-${{ github.run_number }}
          path: scripts/*.log
          retention-days: 7

  # Job 3: ë„¤ì´ë²„ ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ (ì˜¤í›„ 7ì‹œ)
  stock-price-scraper:
    name: Naver Stock Price Collection
    runs-on: ubuntu-latest
    # ì¡°ê±´: ì˜¤í›„ 7ì‹œ ìŠ¤ì¼€ì¤„(UTC 10:00) ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰(stock-price/all)
    if: |
      github.event.schedule == '0 10 * * *' ||
      github.event.inputs.scraper_type == 'stock-price' ||
      github.event.inputs.scraper_type == 'all'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run stock price scraper
        working-directory: ./scripts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        run: |
          echo "ğŸš€ ë„¤ì´ë²„ ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘..."
          node stock-price-scraper.js
          echo "âœ… ë„¤ì´ë²„ ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!"
          echo "â„¹ï¸ mv_stock_analysisëŠ” Regular Viewë¡œ ìë™ ê°±ì‹ ë©ë‹ˆë‹¤."

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: stock-price-scraper-logs-${{ github.run_number }}
          path: scripts/*.log
          retention-days: 7

  # Job 4: ì‹¤íŒ¨ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [fnguide-scraper, consensus-calculator, stock-price-scraper]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "âŒ ë°ì´í„° ìˆ˜ì§‘/ê³„ì‚° ì‹¤íŒ¨!"
          echo "ìˆ˜ë™ ì‹¤í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤."
          echo "ì‹¤íŒ¨í•œ Job ìƒíƒœ:"
          echo "  - FnGuide: ${{ needs.fnguide-scraper.result }}"
          echo "  - Consensus: ${{ needs.consensus-calculator.result }}"
          echo "  - Stock Price: ${{ needs.stock-price-scraper.result }}"
          echo ""
          echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
          echo "1. Actions íƒ­ì—ì„œ ë¡œê·¸ í™•ì¸"
          echo "2. ë¡œì»¬ì—ì„œ ìˆ˜ë™ ì‹¤í–‰:"
          echo "   - cd scripts && node fnguide-scraper.js"
          echo "   - npx tsx scripts/calculate-consensus-batch.ts"
          echo "   - cd scripts && node stock-price-scraper.js"
