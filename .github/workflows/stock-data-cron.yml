name: Stock Data Auto Update

on:
  schedule:
    # í•œêµ­ ì‹œê°„ ì˜¤ì „ 7ì‹œ = UTC 22ì‹œ (ì „ë‚ )
    - cron: '0 22 * * *'
    # í•œêµ­ ì‹œê°„ ì˜¤í›„ 7ì‹œ = UTC 10ì‹œ
    - cron: '0 10 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼ ì¶”ê°€
  workflow_dispatch:
    inputs:
      scraper_type:
        description: 'ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ ì„ íƒ'
        required: true
        type: choice
        options:
          - fnguide
          - stock-price
          - both

jobs:
  # Job 1: FnGuide ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ (ì˜¤ì „ 7ì‹œ)
  fnguide-scraper:
    name: FnGuide Financial Data Collection
    runs-on: ubuntu-latest
    # ì¡°ê±´: ì˜¤ì „ 7ì‹œ ìŠ¤ì¼€ì¤„(UTC 22:00) ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰(fnguide/both)
    if: |
      github.event.schedule == '0 22 * * *' ||
      github.event.inputs.scraper_type == 'fnguide' ||
      github.event.inputs.scraper_type == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run FnGuide scraper
        working-directory: ./scripts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        run: |
          echo "ğŸš€ FnGuide ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘..."
          node fnguide-scraper.js
          echo "âœ… FnGuide ì¬ë¬´ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!"

      - name: Refresh Materialized Views (Financial Data)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ”„ Materialized View ê°±ì‹  ì¤‘..."

          # Supabase REST APIë¥¼ í†µí•œ SQL ì‹¤í–‰
          curl -X POST "${SUPABASE_URL}/rest/v1/rpc/refresh_materialized_views" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            || echo "âš ï¸ RPC í˜¸ì¶œ ì‹¤íŒ¨, ì§ì ‘ psql ì—°ê²° ì‹œë„..."

          # RPC ì‹¤íŒ¨ ì‹œ psql ëŒ€ì•ˆ (IPv4 DNS ê°•ì œ)
          if [ $? -ne 0 ]; then
            # IPv4 ì£¼ì†Œ ì§ì ‘ ì¡°íšŒ
            DB_HOST=$(echo $SUPABASE_URL | sed 's|https://||' | sed 's|http://||')
            IPV4_ADDR=$(getent ahostsv4 "db.${DB_HOST}" | head -n1 | awk '{print $1}')

            if [ -z "$IPV4_ADDR" ]; then
              echo "âŒ IPv4 ì£¼ì†Œ ì¡°íšŒ ì‹¤íŒ¨"
              exit 1
            fi

            echo "âœ… IPv4 ì£¼ì†Œ: $IPV4_ADDR"

            # psql ì„¤ì¹˜
            sudo apt-get update -qq && sudo apt-get install -y -qq postgresql-client

            # IPv4 ì£¼ì†Œë¡œ ì§ì ‘ ì—°ê²°
            export PGPASSWORD="${SUPABASE_SERVICE_KEY}"
            psql "host=${IPV4_ADDR} port=5432 user=postgres dbname=postgres sslmode=require" \
              -c "REFRESH MATERIALIZED VIEW mv_consensus_changes;" \
              -c "REFRESH MATERIALIZED VIEW mv_stock_analysis;"
          fi

          echo "âœ… Materialized View ê°±ì‹  ì™„ë£Œ!"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fnguide-scraper-logs-${{ github.run_number }}
          path: scripts/*.log
          retention-days: 7

  # Job 2: ë„¤ì´ë²„ ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ (ì˜¤í›„ 7ì‹œ)
  stock-price-scraper:
    name: Naver Stock Price Collection
    runs-on: ubuntu-latest
    # ì¡°ê±´: ì˜¤í›„ 7ì‹œ ìŠ¤ì¼€ì¤„(UTC 10:00) ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰(stock-price/both)
    if: |
      github.event.schedule == '0 10 * * *' ||
      github.event.inputs.scraper_type == 'stock-price' ||
      github.event.inputs.scraper_type == 'both'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/package.json

      - name: Install dependencies
        working-directory: ./scripts
        run: npm ci

      - name: Run stock price scraper
        working-directory: ./scripts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
        run: |
          echo "ğŸš€ ë„¤ì´ë²„ ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘..."
          node stock-price-scraper.js
          echo "âœ… ë„¤ì´ë²„ ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ!"

      - name: Refresh Materialized Views (Stock Price Data)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ğŸ”„ Materialized View ê°±ì‹  ì¤‘..."

          # Supabase REST APIë¥¼ í†µí•œ SQL ì‹¤í–‰
          curl -X POST "${SUPABASE_URL}/rest/v1/rpc/refresh_materialized_views" \
            -H "apikey: ${SUPABASE_SERVICE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_KEY}" \
            -H "Content-Type: application/json" \
            || echo "âš ï¸ RPC í˜¸ì¶œ ì‹¤íŒ¨, ì§ì ‘ psql ì—°ê²° ì‹œë„..."

          # RPC ì‹¤íŒ¨ ì‹œ psql ëŒ€ì•ˆ (IPv4 DNS ê°•ì œ)
          if [ $? -ne 0 ]; then
            # IPv4 ì£¼ì†Œ ì§ì ‘ ì¡°íšŒ
            DB_HOST=$(echo $SUPABASE_URL | sed 's|https://||' | sed 's|http://||')
            IPV4_ADDR=$(getent ahostsv4 "db.${DB_HOST}" | head -n1 | awk '{print $1}')

            if [ -z "$IPV4_ADDR" ]; then
              echo "âŒ IPv4 ì£¼ì†Œ ì¡°íšŒ ì‹¤íŒ¨"
              exit 1
            fi

            echo "âœ… IPv4 ì£¼ì†Œ: $IPV4_ADDR"

            # psql ì„¤ì¹˜
            sudo apt-get update -qq && sudo apt-get install -y -qq postgresql-client

            # IPv4 ì£¼ì†Œë¡œ ì§ì ‘ ì—°ê²°
            export PGPASSWORD="${SUPABASE_SERVICE_KEY}"
            psql "host=${IPV4_ADDR} port=5432 user=postgres dbname=postgres sslmode=require" \
              -c "REFRESH MATERIALIZED VIEW mv_consensus_changes;" \
              -c "REFRESH MATERIALIZED VIEW mv_stock_analysis;"
          fi

          echo "âœ… Materialized View ê°±ì‹  ì™„ë£Œ!"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: stock-price-scraper-logs-${{ github.run_number }}
          path: scripts/*.log
          retention-days: 7

  # Job 3: ì‹¤íŒ¨ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [fnguide-scraper, stock-price-scraper]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "âŒ ì£¼ê°€ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨!"
          echo "ìˆ˜ë™ ì‹¤í–‰ì´ í•„ìš”í•©ë‹ˆë‹¤."
          echo "ì‹¤íŒ¨í•œ Job: ${{ needs.fnguide-scraper.result }} / ${{ needs.stock-price-scraper.result }}"
          echo ""
          echo "ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„:"
          echo "1. Actions íƒ­ì—ì„œ ë¡œê·¸ í™•ì¸"
          echo "2. ë¡œì»¬ì—ì„œ ìˆ˜ë™ ì‹¤í–‰:"
          echo "   - node C:\\alexDB\\1_seoul_ys_fnguide_supabase.js"
          echo "   - node C:\\alexDB\\3_ys_stock_supabase.js"
